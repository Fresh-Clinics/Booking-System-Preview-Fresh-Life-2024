<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fetch Cartesian Start Times</title>

    <!-- Include jQuery -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>

    <!-- Include JSON-RPC Client Library for SimplyBook.me -->
    <script src="json-rpc-client.js"></script>
</head>
<body>

<script>
$(document).ready(function () {
    console.log("Fetching events and Cartesian start times...");

    var token = "a5dc632dedf9f85bb8d5bfdd1a8087401787b413111ac0cfbca269a84ec348f3"; // Your provided token
    var start = '2024-10-29'; // Start date
    var end = '2024-10-31'; // End date

    // Initialize JSON-RPC Client for SimplyBook API to fetch events
    var client = new JSONRpcClient({
        'url': 'https://user-api.simplybook.me',
        'headers': {
            'X-Company-Login': 'thefreshlifeconference',
            'X-Token': token
        },
        'onerror': function (error) {
            console.error("Error in JSON-RPC client setup:", error);
        }
    });

    // Fetch events to get eventId and unitId pairs
    client.request('getEventList', [], function (eventData) {
        console.log(eventData); // Log eventData to check its format

        if (typeof eventData === 'object') {
            // Extract eventId and unitId pairs from the eventData
            var eventUnitPairs = extractEventIdUnitPairs(eventData);
            console.log("Event-Unit Pairs:", eventUnitPairs);

            // Fetch Cartesian start times for all event-unit pairs
            fetchCartesianStartTimes(eventUnitPairs, token, start, end);
        } else {
            console.error("Unexpected data format received from API.");
        }
    }, function (error) {
        console.error("Error fetching events:", error);
    });

    // Function to extract eventId and unitId pairs
    function extractEventIdUnitPairs(eventData) {
        var eventUnitPairs = [];
        Object.keys(eventData).forEach(function (eventId) {
            var event = eventData[eventId];
            if (event.unit_map) {
                const unitIds = Object.keys(event.unit_map); // Extract unitIds from unit_map
                unitIds.forEach(unitId => {
                    eventUnitPairs.push({ eventId: parseInt(eventId), unitId: parseInt(unitId) });
                });
            }
        });
        return eventUnitPairs;
    }

    // Function to fetch Cartesian start times
    function fetchCartesianStartTimes(eventUnitPairs, token, start, end) {
        var client = new JSONRpcClient({
            'url': 'https://user-api.simplybook.me',
            'headers': {
                'X-Company-Login': 'thefreshlifeconference',
                'X-Token': token
            },
            'onerror': function (error) {
                console.error("Error in JSON-RPC client setup:", error);
            }
        });

        eventUnitPairs.forEach(function (pair) {
            client.request('getCartesianStartTimeMatrix', [start, end, pair.eventId, pair.unitId, 1, null, []], function (timeMatrix) {
                console.log(`Fetched start times for Event ID ${pair.eventId} and Unit ID ${pair.unitId}:`, timeMatrix);
            }, function (error) {
                console.error(`Error fetching start times for Event ID ${pair.eventId} and Unit ID ${pair.unitId}:`, error);
            });
        });
    }
});
</script>

</body>
</html>
