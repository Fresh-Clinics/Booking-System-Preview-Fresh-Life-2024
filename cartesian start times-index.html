<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fetch Cartesian Start Times</title>

    <!-- Include jQuery -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <!-- Include JSON-RPC Client Library for SimplyBook.me -->
    <script src="json-rpc-client.js"></script>
</head>
<body>

<h1>Fetch Cartesian Start Times</h1>
<div id="status">Fetching data...</div>

<script>
$(document).ready(function () {
    const apiToken = '897ead6108e21774d62e8cdcd7fd1faf16cf003bc5e93e2f8d502be3afc5f878'; // New API key
    const companyLogin = 'thefreshlifeconference';
    const dateFrom = '2024-10-29';
    const dateTo = '2024-10-31';

    // Load events from your saved JSON data
    function loadEventData(callback) {
        $.getJSON('https://raw.githubusercontent.com/Fresh-Clinics/Booking-System-Preview-Fresh-Life-2024/main/data%20pull.json', function(eventData) {
            callback(eventData);
        }).fail(function() {
            console.error("Failed to load event data.");
        });
    }

    // Extract event ID and unit ID pairs from loaded data
    function extractEventIdUnitPairs(eventData) {
        const pairs = [];
        eventData.forEach(event => {
            const unitIds = Object.keys(event.unit_map);
            unitIds.forEach(unitId => {
                pairs.push({
                    eventId: event.id,
                    unitId: parseInt(unitId)
                });
            });
        });
        return pairs;
    }

    // Fetch Cartesian start times
    function fetchCartesianStartTimes(pairs) {
        var client = new JSONRpcClient({
            'url': 'https://user-api.simplybook.me',
            'headers': {
                'X-Company-Login': companyLogin,
                'X-Token': apiToken
            },
            'onerror': function (error) {
                console.error("Error in JSON-RPC client setup:", error);
            }
        });

        pairs.forEach(pair => {
            client.request('getCartesianStartTimeMatrix', [dateFrom, dateTo, pair.eventId, [pair.unitId], 1, null, []], function (timeMatrix) {
                console.log(`Fetched start times for event ${pair.eventId} and unit ${pair.unitId}:`, timeMatrix);
            }, function (error) {
                console.error(`Error fetching start times for event ${pair.eventId} and unit ${pair.unitId}:`, error);
            });
        });
    }

    // Load the event data and process the start times
    loadEventData(function(eventData) {
        const pairs = extractEventIdUnitPairs(eventData);
        fetchCartesianStartTimes(pairs);
        $('#status').text('Data fetching initiated. Check the console for results.');
    });
});
</script>

</body>
</html>
